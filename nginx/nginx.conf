# ============================================================================
# NGINX REVERSE PROXY CONFIGURATION
# ============================================================================
# This is the industry-standard approach for routing traffic to multiple
# services behind a single entry point.
#
# Architecture:
#   Internet → ALB (443/80) → Nginx (80) → Backend Services
#
# Routes:
#   /grafana/*  → Grafana monitoring (port 3000)
#   /*          → CodeDetect app (port 5000)
# ============================================================================

events {
    worker_connections 1024;
}

http {
    # ========================================================================
    # UPSTREAM SERVICES
    # ========================================================================
    # Define backend services that Nginx will proxy to
    # These are Docker service names from docker-compose.yml

    upstream codedetect_app {
        server codedetect:5000;
    }

    upstream grafana_backend {
        server grafana:3000;
    }

    # ========================================================================
    # LOGGING
    # ========================================================================
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;

    # ========================================================================
    # MAIN SERVER CONFIGURATION
    # ========================================================================
    server {
        listen 80;
        server_name codedetect.nt-nick.link;

        # Client body size limit (for file uploads)
        client_max_body_size 100M;

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # ====================================================================
        # GRAFANA MONITORING - /grafana/*
        # ====================================================================
        # Routes all /grafana requests to Grafana container
        # Example: https://codedetect.nt-nick.link/grafana → grafana:3000

        location /grafana/ {
            # Don't use trailing slash in proxy_pass to keep the /grafana path
            proxy_pass http://grafana_backend;

            # WebSocket support (for Grafana live updates)
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            # Forward headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
        }

        # ====================================================================
        # CODEDETECT APPLICATION - /*
        # ====================================================================
        # Routes all other requests to CodeDetect Flask app
        # Example: https://codedetect.nt-nick.link/ → codedetect:5000

        location / {
            proxy_pass http://codedetect_app;

            # Forward headers
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # WebSocket support (if needed for future features)
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # ====================================================================
        # HEALTH CHECK ENDPOINT
        # ====================================================================
        # ALB health check hits this endpoint
        # Nginx forwards to Flask app's /api/health

        location /api/health {
            proxy_pass http://codedetect_app/api/health;
            proxy_set_header Host $host;
            access_log off;  # Don't log health checks (reduces noise)
        }
    }
}

# ============================================================================
# HOW THIS WORKS
# ============================================================================
#
# 1. User visits: https://codedetect.nt-nick.link/grafana
#    └─> ALB (HTTPS 443) decrypts SSL
#    └─> Forwards to Nginx (HTTP 80)
#    └─> Nginx sees "/grafana" path
#    └─> Proxies to grafana:3000
#    └─> Grafana responds
#    └─> Nginx sends back to ALB
#    └─> ALB encrypts and sends to user
#
# 2. User visits: https://codedetect.nt-nick.link/
#    └─> ALB → Nginx → codedetect:5000 → user
#
# 3. ALB health check: http://instance:80/api/health
#    └─> Nginx → codedetect:5000/api/health → 200 OK
#    └─> ALB marks instance as healthy
#
# ============================================================================
# BENEFITS
# ============================================================================
#
# ✅ Single Entry Point: One domain, multiple services
# ✅ Clean URLs: /grafana instead of :3000
# ✅ Security: Services not exposed directly to internet
# ✅ SSL Termination: ALB handles HTTPS, Nginx uses HTTP internally
# ✅ Scalability: Easy to add more services (Prometheus, Kibana, etc.)
# ✅ Industry Standard: Used by Netflix, Uber, Airbnb, etc.
#
# ============================================================================
# ADDING NEW SERVICES (Example: Prometheus)
# ============================================================================
#
# 1. Add upstream:
#    upstream prometheus_backend {
#        server prometheus:9090;
#    }
#
# 2. Add location:
#    location /prometheus/ {
#        proxy_pass http://prometheus_backend/;
#        # ... headers ...
#    }
#
# 3. Add to docker-compose.yml
#
# ============================================================================
