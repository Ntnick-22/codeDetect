name: CI/CD - Staging Deploy

on:
  push:
    branches:
      - staging
  workflow_dispatch:

env:
  DOCKER_USERNAME: nyeinthunaing
  DOCKER_IMAGE: nyeinthunaing/codedetect
  AWS_REGION: eu-west-1
  DOCKER_TAG: staging

jobs:
  build-staging-image:
    name: Build & Push Staging Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build & Push :staging image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:staging
            ${{ env.DOCKER_IMAGE }}:staging-${{ github.sha }}

  deploy-staging:
    name: Deploy Staging to AWS
    needs: build-staging-image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Init
        run: |
          cd terraform
          terraform init

      - name: Terraform Plan for Staging
        run: |
          cd terraform
          terraform plan \
            -var="active_environment=staging" \
            -var="docker_tag=staging" \
            -var="db_password=${{ secrets.DB_PASSWORD }}"

      - name: Terraform Apply for Staging
        run: |
          cd terraform
          terraform apply -auto-approve \
            -var="active_environment=staging" \
            -var="docker_tag=staging" \
            -var="db_password=${{ secrets.DB_PASSWORD }}"

      - name: Wait for Staging Instances to be Healthy
        run: |
          STAGING_ASG="codedetect-staging-asg"
          echo "Waiting for staging instances in $STAGING_ASG"

          for i in {1..20}; do
            DESIRED=$(aws autoscaling describe-auto-scaling-groups \
              --auto-scaling-group-names "$STAGING_ASG" \
              --query 'AutoScalingGroups[0].DesiredCapacity' \
              --output text)

            HEALTHY=$(aws autoscaling describe-auto-scaling-groups \
              --auto-scaling-group-names "$STAGING_ASG" \
              --query 'AutoScalingGroups[0].Instances[?HealthStatus==`Healthy`]|length(@)' \
              --output text)

            echo "Healthy: $HEALTHY / $DESIRED"

            if [ "$HEALTHY" -eq "$DESIRED" ]; then
              echo "Staging environment is healthy!"
              break
            fi

            sleep 15
          done

      - name: Staging Deployment Complete
        run: |
          echo "Staging deployment finished successfully!"
