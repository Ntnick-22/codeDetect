name: CI/CD - Docker Build & Blue/Green Deploy

# When to run this workflow
on:
  push:
    branches:
      - main  # Run on every push to main branch
  workflow_dispatch:  # Allow manual trigger from GitHub UI
    inputs:
      docker_tag:
        description: 'Docker image tag (e.g., v1.0, v1.1)'
        required: false
        default: 'latest'
      deploy_environment:
        description: 'Deploy to blue or green environment'
        required: false
        default: 'blue'
        type: choice
        options:
          - blue
          - green

# Environment variables available to all jobs
env:
  DOCKER_USERNAME: nyeinthunaing
  DOCKER_IMAGE: nyeinthunaing/codedetect
  AWS_REGION: eu-west-1

jobs:
  # =================================================================
  # JOB 1: TEST & QUALITY CHECKS
  # =================================================================
  test:
    name: Run Tests & Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt

      - name: Run Pylint (Code Quality)
        run: |
          echo "=== Running Pylint ==="
          pylint backend/app.py --exit-zero --output-format=colorized || true
          echo ""
          echo "Note: Pylint warnings won't fail the build, but please review them"

      - name: Run Bandit (Security Check)
        continue-on-error: true
        run: |
          echo "=== Running Bandit Security Scan ==="
          pip install pbr  # Install missing dependency
          bandit -r backend/ -f json -o bandit-report.json || true
          bandit -r backend/ -f screen || true
          echo ""
          echo "Security scan complete. Check for HIGH severity issues."

      - name: Test Docker Build
        run: |
          echo "=== Testing Docker Build ==="
          docker build -t codedetect-test:${{ github.sha }} .
          echo "Docker build successful!"

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: |
            bandit-report.json
          retention-days: 30

  # =================================================================
  # JOB 2: BUILD & PUSH DOCKER IMAGE
  # =================================================================
  build-docker:
    name: Build & Push Docker Image
    needs: test
    runs-on: ubuntu-latest

    outputs:
      docker_tag: ${{ steps.generate_tag.outputs.tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate Docker Tag
        id: generate_tag
        run: |
          # If manual trigger with custom tag, use that
          if [ "${{ github.event.inputs.docker_tag }}" != "" ]; then
            TAG="${{ github.event.inputs.docker_tag }}"
          else
            # Auto-generate tag from commit SHA (first 7 chars)
            TAG="v$(date +%Y%m%d)-${GITHUB_SHA::7}"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Generated Docker tag: $TAG"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:${{ steps.generate_tag.outputs.tag }}
            ${{ env.DOCKER_IMAGE }}:latest
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE }}:latest
          cache-to: type=inline

      - name: Image Summary
        run: |
          echo "âœ… Docker image built and pushed successfully!"
          echo ""
          echo "ğŸ“¦ Image: ${{ env.DOCKER_IMAGE }}:${{ steps.generate_tag.outputs.tag }}"
          echo "ğŸ“¦ Latest: ${{ env.DOCKER_IMAGE }}:latest"
          echo ""
          echo "To pull this image:"
          echo "  docker pull ${{ env.DOCKER_IMAGE }}:${{ steps.generate_tag.outputs.tag }}"

  # =================================================================
  # JOB 3: BLUE/GREEN DEPLOYMENT TO AWS
  # =================================================================
  deploy:
    name: Deploy to AWS (Blue/Green)
    needs: build-docker
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Determine Target Environment
        id: target_env
        run: |
          # If manual trigger, use specified environment
          if [ "${{ github.event.inputs.deploy_environment }}" != "" ]; then
            TARGET="${{ github.event.inputs.deploy_environment }}"
          else
            # Auto-determine: Get current active environment, deploy to the other one
            CURRENT=$(terraform -chdir=terraform output -raw active_environment 2>/dev/null || echo "blue")
            if [ "$CURRENT" = "blue" ]; then
              TARGET="green"
            else
              TARGET="blue"
            fi
          fi

          echo "target=$TARGET" >> $GITHUB_OUTPUT
          echo "ğŸ¯ Target environment: $TARGET"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Init
        run: |
          cd terraform
          terraform init

      - name: Blue/Green Deployment
        run: |
          cd terraform

          DOCKER_TAG="${{ needs.build-docker.outputs.docker_tag }}"
          TARGET_ENV="${{ steps.target_env.outputs.target }}"

          echo "=== BLUE/GREEN DEPLOYMENT ==="
          echo "ğŸ³ Docker Tag: $DOCKER_TAG"
          echo "ğŸ¯ Target Environment: $TARGET_ENV"
          echo ""

          # Plan the deployment
          echo "ğŸ“‹ Running Terraform plan..."
          if ! terraform plan \
            -var="active_environment=$TARGET_ENV" \
            -var="docker_tag=$DOCKER_TAG" \
            -out=tfplan; then
            echo "âŒ Terraform plan failed!"
            echo "Showing detailed error logs..."
            terraform plan \
              -var="active_environment=$TARGET_ENV" \
              -var="docker_tag=$DOCKER_TAG" \
              -no-color
            exit 1
          fi

          # Apply the deployment
          echo ""
          echo "ğŸš€ Applying Terraform changes..."
          if ! terraform apply -auto-approve tfplan; then
            echo "âŒ Terraform apply failed!"
            echo "Showing Terraform state..."
            terraform show
            exit 1
          fi

          echo ""
          echo "âœ… Terraform apply completed!"

      - name: Wait for Instances to be Healthy
        run: |
          TARGET_ENV="${{ steps.target_env.outputs.target }}"
          ASG_NAME="codedetect-prod-${TARGET_ENV}-asg"

          echo "=== Waiting for instances in $ASG_NAME to be healthy ==="
          echo "This takes ~5-10 minutes (instance boot + Docker pull + health checks)"

          for i in {1..30}; do
            # Get desired capacity
            DESIRED=$(aws autoscaling describe-auto-scaling-groups \
              --auto-scaling-group-names "$ASG_NAME" \
              --query 'AutoScalingGroups[0].DesiredCapacity' \
              --output text 2>/dev/null || echo "0")

            # Get healthy instance count
            HEALTHY=$(aws autoscaling describe-auto-scaling-groups \
              --auto-scaling-group-names "$ASG_NAME" \
              --query 'AutoScalingGroups[0].Instances[?HealthStatus==`Healthy`]|length(@)' \
              --output text 2>/dev/null || echo "0")

            echo "[$i/30] Healthy instances: $HEALTHY / $DESIRED"

            if [ "$HEALTHY" -ge "$DESIRED" ] && [ "$DESIRED" -gt "0" ]; then
              echo "âœ… All instances are healthy!"
              break
            fi

            sleep 20
          done

      - name: Health Check via Load Balancer
        run: |
          echo "=== Running health check ==="
          sleep 15

          # Try HTTPS health check
          response=$(curl -k -s -o /dev/null -w "%{http_code}" https://codedetect.nt-nick.link/api/health || echo "000")

          if [ "$response" = "200" ]; then
            echo "âœ… Deployment successful!"
            echo ""
            echo "ğŸŒ Application URL: https://codedetect.nt-nick.link"
            echo "ğŸ³ Docker Tag: ${{ needs.build-docker.outputs.docker_tag }}"
            echo "ğŸ¯ Active Environment: ${{ steps.target_env.outputs.target }}"
            echo ""
            echo "App Info:"
            curl -k -s https://codedetect.nt-nick.link/api/info | head -10
          else
            echo "âš ï¸ Health check response: $response"
            echo "Application might still be starting..."

            # Retry a few times
            for i in {1..5}; do
              echo "Retry $i/5..."
              sleep 15
              response=$(curl -k -s -o /dev/null -w "%{http_code}" https://codedetect.nt-nick.link/api/health || echo "000")
              if [ "$response" = "200" ]; then
                echo "âœ… Deployment successful!"
                exit 0
              fi
            done

            echo "âŒ Health check failed. Please check AWS Console."
            exit 1
          fi

      - name: Deployment Summary
        if: always()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š DEPLOYMENT SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ³ Docker Image: ${{ env.DOCKER_IMAGE }}:${{ needs.build-docker.outputs.docker_tag }}"
          echo "ğŸ¯ Deployed to: ${{ steps.target_env.outputs.target }} environment"
          echo "ğŸŒ URL: https://codedetect.nt-nick.link"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Next steps:"
          echo "  - Test the application thoroughly"
          echo "  - Monitor CloudWatch metrics"
          echo "  - If issues, rollback with: terraform apply -var='active_environment=<old-env>'"
